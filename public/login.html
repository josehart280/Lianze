<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - LIANZE</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/login.css">
    <style>
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="index.html" class="logo">LIANZE</a>
                <h1>Iniciar Sesión</h1>
                <p>Bienvenido de vuelta</p>
            </div>

            <form class="auth-form" id="loginForm">
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" class="input" required>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" class="input" required>
                </div>

                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" name="remember">
                        <span class="checkmark"></span>
                        Recordarme
                    </label>
                    <a href="forgot-password.html" class="forgot-link">¿Olvidaste tu contraseña?</a>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <button type="submit" class="btn btn-primary btn-full" id="submitBtn">Iniciar Sesión</button>
            </form>

            <div class="auth-footer">
                <p>¿No tienes cuenta? <a href="register.html">Regístrate aquí</a></p>
            </div>
        </div>
    </div>

    <div id="onboardingModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="onboarding-steps">
            <div class="step active" id="step-0">
                <h2 class="step-title">Bienvenido a LIANZE</h2>
                <div class="step-content">
                    <p>¡Bienvenido! LIANZE es tu plataforma de salud mental donde podrás conectarte con profesionales calificados.</p>
                    <img src="img/1ra.png" alt="Bienvenido" class="onboarding-img">
                </div>
            </div>
            <div class="step" id="step-1">
                <h2 class="step-title">Agenda tus citas</h2>
                <div class="step-content">
                    <p>Puedes programar citas con psicólogos según su disponibilidad y tus necesidades.</p>
                    <img src="img/2da.png" alt="Agendar citas" class="onboarding-img">
                </div>
            </div>
            <div class="step" id="step-2">
                <h2 class="step-title">Diario emocional</h2>
                <div class="step-content">
                    <p>Lleva un registro de tus pensamientos y emociones en tu diario personal.</p>
                    <img src="img/3ra.png" alt="Diario emocional" class="onboarding-img">
                </div>
            </div>
            <div class="step" id="step-3">
                <h2 class="step-title">Comienza ahora</h2>
                <div class="step-content">
                    <p>¡Estás listo! Ahora puedes comenzar a usar LIANZE. Recuerda que siempre puedes acceder a tutoriales desde tu perfil.</p>
                    <img src="img/ready.avif" alt="Listo para comenzar" class="onboarding-img">
                </div>
            </div>
        </div>
        <div class="onboarding-controls">
            <button id="prevBtn" class="btn-secondary" disabled>Anterior</button>
            <button id="nextBtn" class="btn-primary">Siguiente</button>
            <button id="skipBtn" class="btn-link">Saltar</button>
        </div>
    </div>
</div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const errorMessage = document.getElementById('errorMessage');
    const submitBtn = document.getElementById('submitBtn');
    
     const modal = document.getElementById('onboardingModal');
    const closeBtn = document.querySelector('.close');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const steps = document.querySelectorAll('.step');
    
    let currentStep = 0;

    function showOnboarding() {
        // Check if user is first-time (you might want to check this from server response)
        const isFirstTime = true; // This should come from your API response
        if (isFirstTime) {
            modal.style.display = 'block';
            updateStep();
        }
    }

    // Update step display
    function updateStep() {
        steps.forEach((step, index) => {
            step.classList.toggle('active', index === currentStep);
        });
        
        prevBtn.disabled = currentStep === 0;
        nextBtn.textContent = currentStep === steps.length - 1 ? 'Finalizar' : 'Siguiente';
    }

    // Next button click
    nextBtn.addEventListener('click', function() {
        if (currentStep < steps.length - 1) {
            currentStep++;
            updateStep();
        } else {
            modal.style.display = 'none';
            // Mark onboarding as completed (you'll need to implement this)
            markOnboardingCompleted();
        }
    });

    // Previous button click
    prevBtn.addEventListener('click', function() {
        if (currentStep > 0) {
            currentStep--;
            updateStep();
        }
    });

    // Skip button click
    skipBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        markOnboardingCompleted();
    });

    // Close button click
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        markOnboardingCompleted();
    });

    // Close when clicking outside modal
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
            markOnboardingCompleted();
        }
    });

     function markOnboardingCompleted() {
        // Here you would call your API to mark the onboarding as completed
        // For example:
        // fetch('/api/complete-onboarding', { method: 'POST' })
        console.log('Onboarding completed');
    }


    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    function redirectUser(userType) {
        if (userType === 'patient') {
            window.location.href = 'dashboard-patient.html';
        } else if (userType === 'psychologist') {
            window.location.href = 'dashboard-psychologist.html';
        } else {
            showError('Tipo de usuario no reconocido');
        }
    }

    // Función para mostrar modal MFA
    // Función para mostrar modal MFA
function showMFAModal(tempToken) {
    const modal = document.createElement('div');
    modal.className = 'mfa-modal';
    modal.style.display = 'block';
    
    modal.innerHTML = `
        <div class="mfa-modal-content">
            <h2>Autenticación de Dos Factores</h2>
            <p>Por favor ingresa uno de tus códigos de respaldo MFA</p>
            <input type="text" id="mfa-code" placeholder="Código MFA" style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            <button id="verify-mfa-btn" class="btn-primary">Verificar</button>
            <button id="cancel-mfa-btn" class="btn-danger">Cancelar</button>
            <div id="mfa-error" style="color: #e74c3c; margin-top: 1rem; display: none;"></div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('verify-mfa-btn').addEventListener('click', async function() {
    const code = document.getElementById('mfa-code').value;
    const mfaError = document.getElementById('mfa-error');
    
    if (!code) {
        mfaError.textContent = 'Por favor ingresa un código MFA';
        mfaError.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch('/api/verify-mfa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tempToken: tempToken,
                code: code
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Error al verificar MFA');
        }
        
        const data = await response.json();
        
        // Guardar información del usuario en localStorage
        localStorage.setItem('user', JSON.stringify(data.user));
        // Redirigir según el tipo de usuario
        redirectUser(data.user.userType);
        document.body.removeChild(modal);
    } catch (error) {
        console.error('Error:', error);
        mfaError.textContent = error.message || 'Error al verificar MFA';
        mfaError.style.display = 'block';
    }
});
    
    // Manejar cancelación
    document.getElementById('cancel-mfa-btn').addEventListener('click', function() {
    document.body.removeChild(modal);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Iniciar Sesión';
});
    
    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            document.body.removeChild(modal);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Iniciar Sesión';
        }
    });
}




    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorMessage.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Iniciando sesión...';
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email,
                    password
                })
            });
            
            const data = await response.json();
            
           if (response.ok) {
    if (data.requiresMFA) {
        showMFAModal(data.tempToken);
    } else {
        // Guardar token y datos del usuario
        localStorage.setItem('authToken', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));
        
        // Redirigir según tipo de usuario
        redirectUser(data.user.userType);
    }

        } else {
            showError(data.message || 'Credenciales incorrectas');
        }
        } catch (error) {
        console.error('Error:', error);
        showError('Ocurrió un error al iniciar sesión. Por favor, inténtalo más tarde.');
    } finally {
        // Solo restablecer el botón si no se mostró el modal MFA
        if (!document.querySelector('.mfa-modal')) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Iniciar Sesión';
        }
    }
    });
});
    </script>
</body>
</html>