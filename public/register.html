<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrarse - LIANZE</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/register.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="index.html" class="logo">LIANZE</a>
                <h1>Crear Cuenta</h1>
                <p>Únete a nuestra comunidad</p>
            </div>

            <form id="registerForm" class="auth-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Nombre</label>
                        <input type="text" id="firstName" name="firstName" class="input" required 
                               pattern="^[a-zA-Z0-9_.]{5,}$" title="Mínimo 5 caracteres, solo letras, números, _ y .">
                        <div id="firstNameError" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Apellido</label>
                        <input type="text" id="lastName" name="lastName" class="input" required
                               pattern="^[a-zA-Z0-9_.]{5,}$" title="Mínimo 5 caracteres, solo letras, números, _ y .">
                        <div id="lastNameError" class="error-message"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" class="input" required>
                    <div id="emailError" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" class="input" required>
                    <div class="password-strength">
                        <div id="passwordStrengthBar" class="password-strength-bar"></div>
                    </div>
                    <div id="passwordError" class="error-message"></div>
                    <ul class="requirement-list">
                        <li id="lengthReq" class="requirement">Mínimo 12 caracteres</li>
                        <li id="upperReq" class="requirement">Al menos 1 mayúscula</li>
                        <li id="lowerReq" class="requirement">Al menos 1 minúscula</li>
                        <li id="numberReq" class="requirement">Al menos 1 número</li>
                        <li id="specialReq" class="requirement">Al menos 1 símbolo (!@#$%^&*)</li>
                        <li id="commonReq" class="requirement">No usar contraseñas comunes</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar Contraseña</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="input" required>
                    <div id="confirmPasswordError" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="userType">Tipo de Usuario</label>
                    <select id="userType" name="userType" class="input" required>
                        <option value="">Selecciona una opción</option>
                        <option value="patient">Paciente</option>
                        <option value="psychologist">Psicólogo</option>
                    </select>
                </div>

                <div class="form-group">
    <label for="country">País</label>
    <select id="country" name="country" class="input" required>
        <option value="">Selecciona un país</option>
        
    </select>
</div>
<div class="form-group">
    <label for="province">Provincia</label>
    <select id="province" name="province" class="input" disabled required>
        <option value="">Primero selecciona un país</option>
    </select>
</div>

<div class="form-group">
    <label for="canton">Cantón</label>
    <select id="canton" name="canton" class="input" disabled required>
        <option value="">Primero selecciona una provincia</option>
    </select>
</div>

<div class="form-group">
    <label for="district">Distrito</label>
    <select id="district" name="district" class="input" disabled required>
        <option value="">Primero selecciona un cantón</option>
    </select>
</div>


                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" name="terms" required>
                        <span class="checkmark"></span>
                        Acepto los <a href="terms.html">términos y condiciones</a>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary btn-full">Crear Cuenta</button>
            </form>

            <div class="auth-footer">
                <p>¿Ya tienes cuenta? <a href="login.html">Inicia sesión aquí</a></p>
            </div>
        </div>
    </div>

    <script>
        // Lista de contraseñas comunes (puedes ampliarla)
        const commonPasswords = ['password', '123456', 'qwerty', 'admin', 'welcome', 'contraseña', 'password123'];
        

        document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/locations/countries');
        const countries = await response.json();
        
        const countrySelect = document.getElementById('country');
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country.id;
            option.textContent = country.description;
            countrySelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando países:', error);
    }
});

// Manejar cambio de país
document.getElementById('country').addEventListener('change', async function() {
    const countryId = this.value;
    const provinceSelect = document.getElementById('province');
    const cantonSelect = document.getElementById('canton');
    const districtSelect = document.getElementById('district');
    
    // Resetear selects dependientes
    provinceSelect.innerHTML = '<option value="">Selecciona una provincia</option>';
    cantonSelect.innerHTML = '<option value="">Selecciona un cantón</option>';
    districtSelect.innerHTML = '<option value="">Selecciona un distrito</option>';
    
    cantonSelect.disabled = true;
    districtSelect.disabled = true;
    
    if (!countryId) {
        provinceSelect.disabled = true;
        return;
    }
    
    try {
        provinceSelect.disabled = true;
        const response = await fetch(`/api/locations/provinces/${countryId}`);
        const provinces = await response.json();
        
        provinceSelect.innerHTML = '<option value="">Selecciona una provincia</option>';
        provinces.forEach(province => {
            const option = document.createElement('option');
            option.value = province.id;
            option.textContent = province.description;
            provinceSelect.appendChild(option);
        });
        
        provinceSelect.disabled = false;
    } catch (error) {
        console.error('Error cargando provincias:', error);
    }
});

// Manejar cambio de provincia
document.getElementById('province').addEventListener('change', async function() {
    const provinceId = this.value;
    const cantonSelect = document.getElementById('canton');
    const districtSelect = document.getElementById('district');
    
    // Resetear selects dependientes
    cantonSelect.innerHTML = '<option value="">Selecciona un cantón</option>';
    districtSelect.innerHTML = '<option value="">Selecciona un distrito</option>';
    districtSelect.disabled = true;
    
    if (!provinceId) {
        cantonSelect.disabled = true;
        return;
    }
    
    try {
        cantonSelect.disabled = true;
        const response = await fetch(`/api/locations/cantons/${provinceId}`);
        const cantons = await response.json();
        
        cantonSelect.innerHTML = '<option value="">Selecciona un cantón</option>';
        cantons.forEach(canton => {
            const option = document.createElement('option');
            option.value = canton.id;
            option.textContent = canton.description;
            cantonSelect.appendChild(option);
        });
        
        cantonSelect.disabled = false;
    } catch (error) {
        console.error('Error cargando cantones:', error);
    }
});

// Manejar cambio de cantón
document.getElementById('canton').addEventListener('change', async function() {
    const cantonId = this.value;
    const districtSelect = document.getElementById('district');
    
    // Resetear select dependiente
    districtSelect.innerHTML = '<option value="">Selecciona un distrito</option>';
    
    if (!cantonId) {
        districtSelect.disabled = true;
        return;
    }
    
    try {
        districtSelect.disabled = true;
        const response = await fetch(`/api/locations/districts/${cantonId}`);
        const districts = await response.json();
        
        districtSelect.innerHTML = '<option value="">Selecciona un distrito</option>';
        districts.forEach(district => {
            const option = document.createElement('option');
            option.value = district.id;
            option.textContent = district.description;
            districtSelect.appendChild(option);
        });
        
        districtSelect.disabled = false;
    } catch (error) {
        console.error('Error cargando distritos:', error);
    }
});


        document.getElementById('password').addEventListener('input', function() {
            validatePasswordStrength(this.value);
        });
        
        function validatePasswordStrength(password) {
            // Resetear clases
            document.querySelectorAll('.requirement').forEach(el => {
                el.classList.remove('valid', 'invalid');
            });
            
            // Validar cada requisito
            const hasMinLength = password.length >= 12;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecialChar = /[!@#$%^&*]/.test(password);
            const isCommonPassword = commonPasswords.some(common => 
                password.toLowerCase().includes(common.toLowerCase())
            );
            
            // Actualizar indicadores visuales
            updateRequirement('lengthReq', hasMinLength);
            updateRequirement('upperReq', hasUpperCase);
            updateRequirement('lowerReq', hasLowerCase);
            updateRequirement('numberReq', hasNumber);
            updateRequirement('specialReq', hasSpecialChar);
            updateRequirement('commonReq', !isCommonPassword);
            
            // Calcular fortaleza de la contraseña
            let strength = 0;
            if (hasMinLength) strength++;
            if (hasUpperCase) strength++;
            if (hasLowerCase) strength++;
            if (hasNumber) strength++;
            if (hasSpecialChar) strength++;
            if (!isCommonPassword) strength++;
            
            // Actualizar barra de fortaleza
            const strengthBar = document.getElementById('passwordStrengthBar');
            strengthBar.className = 'password-strength-bar';
            
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
            } else if (strength <= 4) {
                strengthBar.classList.add('strength-fair');
            } else if (strength <= 5) {
                strengthBar.classList.add('strength-good');
            } else {
                strengthBar.classList.add('strength-strong');
            }
            
            return hasMinLength && hasUpperCase && hasLowerCase && hasNumber && hasSpecialChar && !isCommonPassword;
        }
        
        function updateRequirement(id, isValid) {
            const element = document.getElementById(id);
            if (isValid) {
                element.classList.add('valid');
                element.classList.remove('invalid');
            } else {
                element.classList.add('invalid');
                element.classList.remove('valid');
            }
        }
        
        function validateName(name) {
            const nameRegex = /^[a-zA-Z0-9_.]{5,}$/;
            const emailRegex = /@/;
            
            if (!nameRegex.test(name)) {
                return { valid: false, message: "Mínimo 5 caracteres, solo letras, números, _ y ." };
            }
            
            if (emailRegex.test(name)) {
                return { valid: false, message: "No puede ser un email" };
            }
            
            return { valid: true };
        }
        
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Limpiar mensajes de error anteriores
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            
            // Obtener valores del formulario
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const userType = document.getElementById('userType').value;
            const countryId = document.getElementById('country').value;
    const provinceId = document.getElementById('province').value;
    const cantonId = document.getElementById('canton').value;
    const districtId = document.getElementById('district').value;
            
            // Validar nombres
            const firstNameValidation = validateName(firstName);
            if (!firstNameValidation.valid) {
                document.getElementById('firstNameError').textContent = firstNameValidation.message;
                return;
            }
            
            const lastNameValidation = validateName(lastName);
            if (!lastNameValidation.valid) {
                document.getElementById('lastNameError').textContent = lastNameValidation.message;
                return;
            }
            
            // Validar contraseña
            const isPasswordValid = validatePasswordStrength(password);
            if (!isPasswordValid) {
                document.getElementById('passwordError').textContent = 'La contraseña no cumple con los requisitos de seguridad';
                return;
            }
            
            // Validar contraseñas coincidan
            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').textContent = 'Las contraseñas no coinciden';
                return;
            }

            if (!countryId) {
        alert('Por favor selecciona un país');
        return;
    }
            
            try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                firstName,
                lastName,
                email,
                password,
                userType,
                countryId,
                provinceId,
                cantonId,
                districtId
            })
        });
        
        const data = await response.json();
        console.log("Respuesta del servidor:", data);
        
        if (response.ok) {
           
            if (data.nextStep === 'security-questions') {

                showBackupCodesModal(data.backupCodes);
                
                document.getElementById('continue-after-codes').addEventListener('click', () => {
            window.location.href = `security-questions.html?userId=${data.userId}&userType=${data.userType}`;
        });
            } else {
                
                if (data.userType === 'patient') {
                    window.location.href = 'dashboard-patient.html';
                } else if (data.userType === 'psychologist') {
                    window.location.href = 'dashboard-psychologist.html';
                }
            }
        } else {
            // Mostrar error del servidor
            if (data.message && data.message.includes('email')) {
                document.getElementById('emailError').textContent = data.message;
            } else {
                alert(data.message || 'Error en el registro');
            }
        }


function showBackupCodesModal(codes) {
    const modal = document.createElement('div');
    modal.className = 'mfa-modal';
    modal.innerHTML = `
        <div class="mfa-modal-content">
            <h2>Tus Códigos de Respaldo MFA</h2>
            <p>Guarda estos códigos en un lugar seguro. Cada código solo se puede usar una vez.</p>
            <div class="backup-codes-container">
                ${codes.map(code => `<div class="backup-code">${code}</div>`).join('')}
            </div>
            <button id="copy-codes-btn">Copiar Códigos</button>
            <button id="continue-after-codes">Continuar</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Copiar códigos al portapapeles
    document.getElementById('copy-codes-btn').addEventListener('click', () => {
        navigator.clipboard.writeText(codes.join('\n'));
        alert('Códigos copiados al portapapeles');
    });
    
    // Estilos para el modal
    const style = document.createElement('style');
    style.textContent = `
        .mfa-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .mfa-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .backup-codes-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 1rem 0;
        }
        .backup-code {
            padding: 0.5rem;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.1rem;
        }
        .mfa-modal-content button {
            margin: 0.5rem;
            padding: 0.5rem 1rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    `;
    document.head.appendChild(style);
}





    } catch (error) {
        console.error('Error:', error);
        alert('Ocurrió un error al registrar. Por favor, inténtalo más tarde.');
    }
});
    </script>
</body>
</html>