<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - LIANZE</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <nav class="mobile-nav md:hidden">
        <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <a href="index.html" class="mobile-logo">LIANZE</a>
    </nav>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="logo">
                <span class="logo-text">LIANZE</span>
                <span class="logo-icon"><i class="fas fa-heart"></i></span>
            </a>
            <button class="close-sidebar" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li><a href="dashboard-patient.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="appointments.html"><i class="fas fa-calendar-check"></i> Mis Citas</a></li>
                <li><a href="psychologists.html"><i class="fas fa-user-md"></i> Psicólogos</a></li>
                <li><a href="diary.html"><i class="fas fa-book"></i> Mi Diario</a></li>
                <li><a href="calendar.html"><i class="fas fa-calendar-alt"></i> Calendario</a></li>
                <li class="active"><a href="profile.html"><i class="fas fa-user"></i> Mi Perfil</a></li>
                <li><a href="settings.html"><i class="fas fa-cog"></i> Configuración</a></li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <a href="index.html" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </aside>


    <div class="overlay" onclick="toggleSidebar()"></div>

    <main class="main-content">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-image-container">
                    <img id="profileImageDisplay" class="profile-image" src="" alt="Foto de perfil">
                    <label class="profile-image-upload">
                        Cambiar foto
                        <input type="file" id="profileImageInput" accept="image/*">
                    </label>
                </div>
                <div class="profile-info">
                    <h1 id="profileName">Cargando...</h1>
                    <p id="profileEmail">Cargando...</p>
                    <p id="profileType">Cargando...</p>
                </div>
            </div>

            <div class="profile-section">
                <h2>Información Personal</h2>
                <div class="profile-details">
                    <div class="detail-group">
                        <label>Nombre</label>
                        <div class="view-mode readonly-info" id="firstNameView"></div>
                        <input type="text" id="firstNameEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Apellido</label>
                        <div class="view-mode readonly-info" id="lastNameView"></div>
                        <input type="text" id="lastNameEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Correo Electrónico</label>
                        <div class="view-mode readonly-info" id="emailView"></div>
                        <input type="email" id="emailEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Teléfono</label>
                        <div class="view-mode readonly-info" id="phoneView"></div>
                        <input type="tel" id="phoneEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Fecha de Nacimiento</label>
                        <div class="view-mode readonly-info" id="dobView"></div>
                        <input type="date" id="dobEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Género</label>
                        <div class="view-mode readonly-info" id="genderView"></div>
                        <select id="genderEdit" class="edit-mode">
                            <option value="">Seleccionar</option>
                            <option value="male">Masculino</option>
                            <option value="female">Femenino</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h2>Biografía</h2>
                <div class="view-mode readonly-info" id="bioView">No hay biografía disponible</div>
                <textarea id="bioEdit" class="edit-mode" placeholder="Escribe algo sobre ti..."></textarea>
            </div>

            <div class="action-buttons">
                <button id="editBtn" class="btn-edit">Editar Perfil</button>
                <button id="saveBtn" class="btn-edit edit-mode">Guardar Cambios</button>
                <button id="cancelBtn" class="btn-cancel edit-mode">Cancelar</button>
            </div>
        </div>

        <div class="profile-section">
                <h2>Métodos de Pago</h2>
                <div id="paymentMethodsContainer">
                    <div class="no-payment-methods">
                        No tienes métodos de pago registrados
                    </div>
                </div>
                
                <button id="addPaymentMethodBtn" class="btn-edit">Agregar Método de Pago</button>
            </div>

            <!-- Modal para agregar/editar tarjeta -->
            <div id="paymentMethodModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="paymentModalTitle">Agregar Nueva Tarjeta</h2>
                    
                    <form id="paymentMethodForm">
                        <input type="hidden" id="cardId">
                        
                        <div class="form-group">
                            <label for="cardNumber">Número de Tarjeta</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        
                        <div class="form-group">
                            <label for="cardHolder">Nombre en la Tarjeta</label>
                            <input type="text" id="cardHolder" placeholder="Nombre como aparece en la tarjeta">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expirationMonth">Mes de Expiración</label>
                                <select id="expirationMonth">
                                    <option value="">MM</option>
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <!-- ... todos los meses ... -->
                                    <option value="12">12</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="expirationYear">Año de Expiración</label>
                                <select id="expirationYear">
                                    <option value="">YYYY</option>
                                    <!-- Años desde el actual hasta +10 años -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" placeholder="123" maxlength="4">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="initialBalance">Saldo Inicial (opcional)</label>
                            <input type="number" id="initialBalance" placeholder="0.00" step="0.01" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="isDefault"> 
                                Establecer como método de pago predeterminado
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-edit">Guardar</button>
                            <button type="button" class="btn-cancel cancel-modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

    </main>

    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            
            // Bloquear scroll del body cuando el menú está abierto
            document.body.classList.toggle('no-scroll');
        }

        // Cerrar sidebar al hacer clic en un enlace en móviles
        document.querySelectorAll('.sidebar-nav a').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth < 768) {
                    toggleSidebar();
                }
            });
        });

        // Cerrar sidebar al hacer clic fuera en móviles
        document.addEventListener('click', function(e) {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.menu-toggle');
            
            if (window.innerWidth < 768 && 
                sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && 
                e.target !== menuToggle && 
                !e.target.closest('.menu-toggle')) {
                toggleSidebar();
            }
        });

       
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const profileImageInput = document.getElementById('profileImageInput');
    const profileImageDisplay = document.getElementById('profileImageDisplay');
    const paymentMethodsContainer = document.getElementById('paymentMethodsContainer');
    const addPaymentMethodBtn = document.getElementById('addPaymentMethodBtn');
    const paymentMethodModal = document.getElementById('paymentMethodModal');
    const paymentMethodForm = document.getElementById('paymentMethodForm');
    const closeModalBtn = document.querySelector('.close-modal');
    const cancelModalBtn = document.querySelector('.cancel-modal');
    
    // Obtener usuario logueado
    function getLoggedInUser() {
    const userData = localStorage.getItem('user');
    const token = localStorage.getItem('authToken');
    
    if (!userData || !token) {
        window.location.href = 'login.html';
        return null;
    }
    
    try {
        return JSON.parse(userData);
    } catch (e) {
        window.location.href = 'login.html';
        return null;
    }
}
    
    // Mostrar alerta
    function showAlert(message, isSuccess = true) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${isSuccess ? 'success' : 'error'}`;
        alertDiv.textContent = message;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.style.animation = 'fadeOut 0.3s';
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 300);
        }, 3000);
    }
    
    // Cargar datos del perfil
    async function loadProfile() {
        const user = getLoggedInUser();
    if (!user) return;
    
    const token = localStorage.getItem('authToken');
    
    try {
        const response = await fetch(`/api/user-profile/${user.id}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                // Token inválido o expirado
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
                return;
            }
            throw new Error('Error al cargar el perfil');
        }
            
            const userData = await response.json();
    
         // Desencriptar email si es necesario
         if (userData.email && userData.email.includes(':')) {
             try {
                 userData.email = decrypt(userData.email);
             } catch (e) {
                 console.error('Error desencriptando email:', e);
             }
         }

            
            // Mostrar datos en la vista
            document.getElementById('profileName').textContent = `${userData.firstName} ${userData.lastName}`;
            document.getElementById('profileEmail').textContent = userData.email;
            document.getElementById('profileType').textContent = userData.userType === 'psychologist' ? 'Psicólogo' : 'Paciente';
            
            // Información personal
            document.getElementById('firstNameView').textContent = userData.firstName;
            document.getElementById('firstNameEdit').value = userData.firstName;
            
            document.getElementById('lastNameView').textContent = userData.lastName;
            document.getElementById('lastNameEdit').value = userData.lastName;
            
            document.getElementById('emailView').textContent = userData.email;
            document.getElementById('emailEdit').value = userData.email;
            
            document.getElementById('phoneView').textContent = userData.phone || 'No especificado';
            document.getElementById('phoneEdit').value = userData.phone || '';
            
            document.getElementById('dobView').textContent = userData.dateOfBirth ? new Date(userData.dateOfBirth).toLocaleDateString() : 'No especificada';
            document.getElementById('dobEdit').value = userData.dateOfBirth || '';
            
            document.getElementById('genderView').textContent = 
                userData.gender === 'male' ? 'Masculino' : 
                userData.gender === 'female' ? 'Femenino' : 
                userData.gender === 'other' ? 'Otro' : 'No especificado';
            document.getElementById('genderEdit').value = userData.gender || '';
            
            // Biografía
            document.getElementById('bioView').textContent = userData.bio || 'No hay biografía disponible';
            document.getElementById('bioEdit').value = userData.bio || '';
            
            // Imagen de perfil
            if (userData.profileImage) {
                profileImageDisplay.src = userData.profileImage;
            } else {
                profileImageDisplay.src = 'images/default-profile.png';
            }
            
            await loadPaymentMethods();
        } catch (error) {
            console.error('Error cargando perfil:', error);
            showAlert('Error al cargar el perfil', false);
        }
    }
    
    // Manejar edición del perfil
    editBtn.addEventListener('click', function() {
        document.body.classList.add('edit');
    });
    
    // Cancelar edición
    cancelBtn.addEventListener('click', function() {
        document.body.classList.remove('edit');
        loadProfile(); // Recargar datos originales
    });
    
    // Guardar cambios
    saveBtn.addEventListener('click', async function() {
        const user = getLoggedInUser();
        if (!user) return;

        const token = localStorage.getItem('authToken');
        
        const formData = new FormData();
        formData.append('userId', user.id);
        formData.append('firstName', document.getElementById('firstNameEdit').value);
        formData.append('lastName', document.getElementById('lastNameEdit').value);
        formData.append('email', document.getElementById('emailEdit').value);
        formData.append('phone', document.getElementById('phoneEdit').value);
        formData.append('dateOfBirth', document.getElementById('dobEdit').value);
        formData.append('gender', document.getElementById('genderEdit').value);
        formData.append('bio', document.getElementById('bioEdit').value);
        
        // Agregar imagen si se seleccionó una
        if (profileImageInput.files[0]) {
            formData.append('profileImage', profileImageInput.files[0]);
        }
        
        try {
            const response = await fetch('/api/update-profile', {
                method: 'POST',
                headers: {
                'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showAlert('Perfil actualizado correctamente');
                // Actualizar datos en localStorage
                const updatedUser = {
                    ...user,
                    firstName: document.getElementById('firstNameEdit').value,
                    lastName: document.getElementById('lastNameEdit').value,
                    email: document.getElementById('emailEdit').value,
                    profileImage: data.profileImage || user.profileImage
                };
                localStorage.setItem('user', JSON.stringify(updatedUser));
                
                // Salir del modo edición
                document.body.classList.remove('edit');
                
                // Recargar perfil
                loadProfile();
            } else {
                showAlert(data.message || 'Error al actualizar el perfil', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error de conexión al actualizar el perfil', false);
        }
    });
    
    // Previsualizar imagen seleccionada
    profileImageInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                profileImageDisplay.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });
    
    // Llenar años de expiración
    const expirationYearSelect = document.getElementById('expirationYear');
    const currentYear = new Date().getFullYear();
    for (let i = 0; i < 10; i++) {
        const option = document.createElement('option');
        option.value = currentYear + i;
        option.textContent = currentYear + i;
        expirationYearSelect.appendChild(option);
    }
    
    // Formatear número de tarjeta
    document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s+/g, '');
        if (value.length > 0) {
            value = value.match(new RegExp('.{1,4}', 'g')).join(' ');
        }
        e.target.value = value;
    });
    
    // Manejar modal
    addPaymentMethodBtn.addEventListener('click', function() {
        document.getElementById('paymentModalTitle').textContent = 'Agregar Nueva Tarjeta';
        paymentMethodForm.reset();
        document.getElementById('cardId').value = '';
        paymentMethodModal.style.display = 'block';
    });
    
    closeModalBtn.addEventListener('click', function() {
        paymentMethodModal.style.display = 'none';
    });
    
    cancelModalBtn.addEventListener('click', function() {
        paymentMethodModal.style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        if (event.target === paymentMethodModal) {
            paymentMethodModal.style.display = 'none';
        }
    });
    
    // Cargar métodos de pago - FUNCIÓN CORREGIDA
    async function loadPaymentMethods() {
    const user = getLoggedInUser();
    if (!user) return;
    
    try {
        // Obtener métodos de pago
        const paymentMethodsResponse = await fetch(`/api/payment-methods/${user.id}`);
        if (!paymentMethodsResponse.ok) {
            throw new Error('Error al cargar métodos de pago');
        }
        const paymentMethods = await paymentMethodsResponse.json();
        
        // Obtener balance de cuentas bancarias
        const balanceResponse = await fetch(`/api/bank-accounts/${user.id}/balance`);
        const balanceData = await balanceResponse.json();
        const balance = balanceData.balance || 0;
        
        if (paymentMethods.length === 0) {
            paymentMethodsContainer.innerHTML = `
                <div class="no-payment-methods">
                    No tienes métodos de pago registrados
                </div>
            `;
            return;
        }
        
        paymentMethodsContainer.innerHTML = '';
        
        paymentMethods.forEach(method => {
            const cardElement = document.createElement('div');
            cardElement.className = `payment-card ${method.isDefault ? 'default' : ''}`;
            cardElement.innerHTML = `
                <div class="payment-card-header">
                    <span class="payment-card-type">Tarjeta de ${method.isDefault ? 'Crédito (Predeterminada)' : 'Crédito'}</span>
                    ${method.isDefault ? '<span class="payment-card-default">PREDETERMINADA</span>' : ''}
                </div>
                <div class="payment-card-number">${method.cardNumber}</div>
                <div class="payment-card-details">
                    <span>${method.cardHolder}</span>
                    <span>Expira: ${method.expirationMonth}/${method.expirationYear}</span>
                </div>
                <div class="payment-card-actions">
                    <button class="btn-edit edit-card" data-id="${method.id}">Editar</button>
                    <button class="btn-cancel delete-card" data-id="${method.id}">Eliminar</button>
                    ${!method.isDefault ? `<button class="btn-edit set-default" data-id="${method.id}">Establecer como predeterminada</button>` : ''}
                </div>
                <div class="payment-card-balance">Saldo disponible en cuenta: $${balance.toFixed(2)}</div>
            `;
            paymentMethodsContainer.appendChild(cardElement);
        });
            
            // Agregar event listeners a los botones
            document.querySelectorAll('.edit-card').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const cardId = this.getAttribute('data-id');
                    await loadCardForEdit(cardId);
                });
            });
            
            document.querySelectorAll('.delete-card').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const cardId = this.getAttribute('data-id');
                    if (confirm('¿Estás seguro de que deseas eliminar este método de pago?')) {
                        await deletePaymentMethod(cardId);
                    }
                });
            });
            
            document.querySelectorAll('.set-default').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const cardId = this.getAttribute('data-id');
                    await setDefaultPaymentMethod(cardId);
                });
            });
            
        } catch (error) {
            console.error('Error cargando métodos de pago:', error);
            showAlert('Error al cargar métodos de pago', false);
        }
    }
    
    // Cargar tarjeta para editar
    async function loadCardForEdit(cardId) {
        try {
            const user = getLoggedInUser();
            const response = await fetch(`/api/payment-methods/${user.id}`);
            if (!response.ok) {
                throw new Error('Error al cargar tarjeta');
            }
            
            const paymentMethods = await response.json();
            const card = paymentMethods.find(m => m.id == cardId);
            
            if (!card) {
                throw new Error('Tarjeta no encontrada');
            }
            
            document.getElementById('paymentModalTitle').textContent = 'Editar Tarjeta';
            document.getElementById('cardId').value = card.id;
            document.getElementById('cardNumber').value = card.cardNumber;
            document.getElementById('cardHolder').value = card.cardHolder;
            document.getElementById('expirationMonth').value = card.expirationMonth;
            document.getElementById('expirationYear').value = card.expirationYear;
            document.getElementById('isDefault').checked = card.isDefault;
            
            paymentMethodModal.style.display = 'block';
        } catch (error) {
            console.error('Error cargando tarjeta:', error);
            showAlert('Error al cargar tarjeta para edición', false);
        }
    }
    
    // Guardar tarjeta
    paymentMethodForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const user = getLoggedInUser();
        if (!user) return;
        
        const cardId = document.getElementById('cardId').value;
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
        const cardHolder = document.getElementById('cardHolder').value;
        const expirationMonth = document.getElementById('expirationMonth').value;
        const expirationYear = document.getElementById('expirationYear').value;
        const cvv = document.getElementById('cvv').value;
        const initialBalance = document.getElementById('initialBalance').value || 0;
        const isDefault = document.getElementById('isDefault').checked;
        
        // Validaciones
        if (!cardNumber || !cardHolder || !expirationMonth || !expirationYear || !cvv) {
            showAlert('Todos los campos son requeridos', false);
            return;
        }

        try {
            let response;
            let url;
            let method;
            
            if (cardId) {
                // Actualizar tarjeta existente
                url = `/api/payment-methods/${cardId}`;
                method = 'PUT';
                const body = {
                    cardHolder,
                    expirationMonth,
                    expirationYear,
                    isDefault
                };
                response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            } else {
                // Crear nueva tarjeta
                url = '/api/payment-methods';
                method = 'POST';
                const body = {
                    userId: user.id,
                    cardNumber,
                    cardHolder,
                    expirationMonth,
                    expirationYear,
                    cvv,
                    balance: parseFloat(initialBalance)
                };
                response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            }
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Error al guardar tarjeta');
            }
            
            showAlert(data.message || 'Tarjeta guardada correctamente');
            paymentMethodModal.style.display = 'none';
            loadPaymentMethods();
        } catch (error) {
            console.error('Error:', error);
            showAlert(error.message || 'Error al guardar tarjeta', false);
        }
    });
    
    // Eliminar tarjeta
    async function deletePaymentMethod(cardId) {
        try {
            const response = await fetch(`/api/payment-methods/${cardId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Error al eliminar tarjeta');
            }
            
            const data = await response.json();
            showAlert(data.message || 'Tarjeta eliminada correctamente');
            loadPaymentMethods();
        } catch (error) {
            console.error('Error eliminando tarjeta:', error);
            showAlert('Error al eliminar tarjeta', false);
        }
    }
    
    // Establecer tarjeta predeterminada
    async function setDefaultPaymentMethod(cardId) {
        try {
            const response = await fetch(`/api/payment-methods/${cardId}/set-default`, {
                method: 'PUT'
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Error al establecer tarjeta predeterminada');
            }
            
            showAlert(data.message || 'Tarjeta establecida como predeterminada');
            loadPaymentMethods();
        } catch (error) {
            console.error('Error:', error);
            showAlert(error.message || 'Error al establecer tarjeta predeterminada', false);
        }
    }
    
    // Cargar métodos de pago al iniciar
    loadPaymentMethods();
    
    // Cargar perfil al iniciar
    loadProfile();
});
    </script>
</body>
</html>