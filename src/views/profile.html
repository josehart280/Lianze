<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - LIANZE</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/profile.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="logo">LIANZE</a>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="dashboard-patient.html">Dashboard</a></li>
                <li><a href="appointments.html">Mis Citas</a></li>
                <li><a href="psychologists.html">Psicólogos</a></li>
                <li><a href="diary.html">Mi Diario</a></li>
                <li><a href="calendar.html">Calendario</a></li>
                <li><a href="profile.html" class="active">Mi Perfil</a></li>
                <li><a href="settings.html">Configuración</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <a href="index.html" class="logout-btn">Cerrar Sesión</a>
        </div>
    </aside>

    <main class="main-content">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-image-container">
                    <img id="profileImageDisplay" class="profile-image" src="" alt="Foto de perfil">
                    <label class="profile-image-upload">
                        Cambiar foto
                        <input type="file" id="profileImageInput" accept="image/*">
                    </label>
                </div>
                <div class="profile-info">
                    <h1 id="profileName">Cargando...</h1>
                    <p id="profileEmail">Cargando...</p>
                    <p id="profileType">Cargando...</p>
                </div>
            </div>

            <div class="profile-section">
                <h2>Información Personal</h2>
                <div class="profile-details">
                    <div class="detail-group">
                        <label>Nombre</label>
                        <div class="view-mode readonly-info" id="firstNameView"></div>
                        <input type="text" id="firstNameEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Apellido</label>
                        <div class="view-mode readonly-info" id="lastNameView"></div>
                        <input type="text" id="lastNameEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Correo Electrónico</label>
                        <div class="view-mode readonly-info" id="emailView"></div>
                        <input type="email" id="emailEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Teléfono</label>
                        <div class="view-mode readonly-info" id="phoneView"></div>
                        <input type="tel" id="phoneEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Fecha de Nacimiento</label>
                        <div class="view-mode readonly-info" id="dobView"></div>
                        <input type="date" id="dobEdit" class="edit-mode">
                    </div>
                    
                    <div class="detail-group">
                        <label>Género</label>
                        <div class="view-mode readonly-info" id="genderView"></div>
                        <select id="genderEdit" class="edit-mode">
                            <option value="">Seleccionar</option>
                            <option value="male">Masculino</option>
                            <option value="female">Femenino</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h2>Biografía</h2>
                <div class="view-mode readonly-info" id="bioView">No hay biografía disponible</div>
                <textarea id="bioEdit" class="edit-mode" placeholder="Escribe algo sobre ti..."></textarea>
            </div>

            <div class="action-buttons">
                <button id="editBtn" class="btn-edit">Editar Perfil</button>
                <button id="saveBtn" class="btn-edit edit-mode">Guardar Cambios</button>
                <button id="cancelBtn" class="btn-cancel edit-mode">Cancelar</button>
            </div>
        </div>

        <div class="profile-section">
                <h2>Métodos de Pago</h2>
                <div id="paymentMethodsContainer">
                    <div class="no-payment-methods">
                        No tienes métodos de pago registrados
                    </div>
                </div>
                
                <button id="addPaymentMethodBtn" class="btn-edit">Agregar Método de Pago</button>
            </div>

            <!-- Modal para agregar/editar tarjeta -->
            <div id="paymentMethodModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="paymentModalTitle">Agregar Nueva Tarjeta</h2>
                    
                    <form id="paymentMethodForm">
                        <input type="hidden" id="cardId">
                        
                        <div class="form-group">
                            <label for="cardNumber">Número de Tarjeta</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        
                        <div class="form-group">
                            <label for="cardHolder">Nombre en la Tarjeta</label>
                            <input type="text" id="cardHolder" placeholder="Nombre como aparece en la tarjeta">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expirationMonth">Mes de Expiración</label>
                                <select id="expirationMonth">
                                    <option value="">MM</option>
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <!-- ... todos los meses ... -->
                                    <option value="12">12</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="expirationYear">Año de Expiración</label>
                                <select id="expirationYear">
                                    <option value="">YYYY</option>
                                    <!-- Años desde el actual hasta +10 años -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" placeholder="123" maxlength="4">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="initialBalance">Saldo Inicial (opcional)</label>
                            <input type="number" id="initialBalance" placeholder="0.00" step="0.01" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="isDefault"> 
                                Establecer como método de pago predeterminado
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-edit">Guardar</button>
                            <button type="button" class="btn-cancel cancel-modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const profileImageInput = document.getElementById('profileImageInput');
            const profileImageDisplay = document.getElementById('profileImageDisplay');
            
            // Obtener usuario logueado
            function getLoggedInUser() {
                const user = localStorage.getItem('user');
                if (!user) {
                    window.location.href = 'login.html';
                    return null;
                }
                return JSON.parse(user);
            }
            
            // Mostrar alerta
            function showAlert(message, isSuccess = true) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${isSuccess ? 'success' : 'error'}`;
                alertDiv.textContent = message;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => {
                        document.body.removeChild(alertDiv);
                    }, 300);
                }, 3000);
            }
            
            // Cargar datos del perfil
            async function loadProfile() {
                const user = getLoggedInUser();
                if (!user) return;
                
                try {
                    // Obtener datos completos del usuario
                    const response = await fetch(`/api/user-profile/${user.id}`);
        if (!response.ok) {
            throw new Error('Error al cargar el perfil');
        }
                    
                    const userData = await response.json();
                    
                    // Mostrar datos en la vista
                    document.getElementById('profileName').textContent = `${userData.firstName} ${userData.lastName}`;
                    document.getElementById('profileEmail').textContent = userData.email;
                    document.getElementById('profileType').textContent = userData.userType === 'psychologist' ? 'Psicólogo' : 'Paciente';
                    
                    // Información personal
                    document.getElementById('firstNameView').textContent = userData.firstName;
                    document.getElementById('firstNameEdit').value = userData.firstName;
                    
                    document.getElementById('lastNameView').textContent = userData.lastName;
                    document.getElementById('lastNameEdit').value = userData.lastName;
                    
                    document.getElementById('emailView').textContent = userData.email;
                    document.getElementById('emailEdit').value = userData.email;
                    
                    document.getElementById('phoneView').textContent = userData.phone || 'No especificado';
                    document.getElementById('phoneEdit').value = userData.phone || '';
                    
                    document.getElementById('dobView').textContent = userData.dateOfBirth ? new Date(userData.dateOfBirth).toLocaleDateString() : 'No especificada';
                    document.getElementById('dobEdit').value = userData.dateOfBirth || '';
                    
                    document.getElementById('genderView').textContent = 
                        userData.gender === 'male' ? 'Masculino' : 
                        userData.gender === 'female' ? 'Femenino' : 
                        userData.gender === 'other' ? 'Otro' : 'No especificado';
                    document.getElementById('genderEdit').value = userData.gender || '';
                    
                    // Biografía
                    document.getElementById('bioView').textContent = userData.bio || 'No hay biografía disponible';
                    document.getElementById('bioEdit').value = userData.bio || '';
                    
                    // Imagen de perfil
                    if (userData.profileImage) {
                        profileImageDisplay.src = userData.profileImage;
                    } else {
                        profileImageDisplay.src = 'images/default-profile.png';
                    }
                    await loadPaymentMethods();
                } catch (error) {
                    console.error('Error cargando perfil:', error);
                    showAlert('Error al cargar el perfil', false);
                }
            }
            
            // Manejar edición del perfil
            editBtn.addEventListener('click', function() {
                document.body.classList.add('edit');
            });
            
            // Cancelar edición
            cancelBtn.addEventListener('click', function() {
                document.body.classList.remove('edit');
                loadProfile(); // Recargar datos originales
            });
            
            // Guardar cambios
            saveBtn.addEventListener('click', async function() {
        const user = getLoggedInUser();
        if (!user) return;
        
        const formData = new FormData();
        formData.append('userId', user.id);
        formData.append('firstName', document.getElementById('firstNameEdit').value);
        formData.append('lastName', document.getElementById('lastNameEdit').value);
        formData.append('email', document.getElementById('emailEdit').value);
        formData.append('phone', document.getElementById('phoneEdit').value);
        formData.append('dateOfBirth', document.getElementById('dobEdit').value);
        formData.append('gender', document.getElementById('genderEdit').value);
        formData.append('bio', document.getElementById('bioEdit').value);
        
        // Agregar imagen si se seleccionó una
        if (profileImageInput.files[0]) {
            formData.append('profileImage', profileImageInput.files[0]);
        }
        
        try {
            const response = await fetch('/api/update-profile', {
                method: 'POST',
                body: formData
                // No agregues headers cuando usas FormData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showAlert('Perfil actualizado correctamente');
                // Actualizar datos en localStorage
                const updatedUser = {
                    ...user,
                    firstName: document.getElementById('firstNameEdit').value,
                    lastName: document.getElementById('lastNameEdit').value,
                    email: document.getElementById('emailEdit').value,
                    profileImage: data.profileImage || user.profileImage
                };
                localStorage.setItem('user', JSON.stringify(updatedUser));
                
                // Salir del modo edición
                document.body.classList.remove('edit');
                
                // Recargar perfil
                loadProfile();
            } else {
                showAlert(data.message || 'Error al actualizar el perfil', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error de conexión al actualizar el perfil', false);
        }
    });
            
            // Previsualizar imagen seleccionada
            profileImageInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        profileImageDisplay.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            const paymentMethodsContainer = document.getElementById('paymentMethodsContainer');
            const addPaymentMethodBtn = document.getElementById('addPaymentMethodBtn');
            const paymentMethodModal = document.getElementById('paymentMethodModal');
            const paymentMethodForm = document.getElementById('paymentMethodForm');
            const closeModalBtn = document.querySelector('.close-modal');
            const cancelModalBtn = document.querySelector('.cancel-modal');
            
            // Llenar años de expiración
            const expirationYearSelect = document.getElementById('expirationYear');
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 10; i++) {
                const option = document.createElement('option');
                option.value = currentYear + i;
                option.textContent = currentYear + i;
                expirationYearSelect.appendChild(option);
            }
            
            // Formatear número de tarjeta
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '');
                if (value.length > 0) {
                    value = value.match(new RegExp('.{1,4}', 'g')).join(' ');
                }
                e.target.value = value;
            });
            
            // Manejar modal
            addPaymentMethodBtn.addEventListener('click', function() {
                document.getElementById('paymentModalTitle').textContent = 'Agregar Nueva Tarjeta';
                paymentMethodForm.reset();
                document.getElementById('cardId').value = '';
                paymentMethodModal.style.display = 'block';
            });
            
            closeModalBtn.addEventListener('click', function() {
                paymentMethodModal.style.display = 'none';
            });
            
            cancelModalBtn.addEventListener('click', function() {
                paymentMethodModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === paymentMethodModal) {
                    paymentMethodModal.style.display = 'none';
                }
            });
            
            // Cargar métodos de pago
            async function loadPaymentMethods() {
                const user = getLoggedInUser();
                if (!user) return;
                
                try {
                    const response = await fetch(`/api/payment-methods/${user.id}`);
                    if (!response.ok) {
                        throw new Error('Error al cargar métodos de pago');
                    }
                    
                    const paymentMethods = await response.json();
                    
                    if (paymentMethods.length === 0) {
                        paymentMethodsContainer.innerHTML = `
                            <div class="no-payment-methods">
                                No tienes métodos de pago registrados
                            </div>
                        `;
                        return;
                    }
                    
                    paymentMethodsContainer.innerHTML = '';
                    
                    paymentMethods.forEach(method => {
                        const cardElement = document.createElement('div');
                        cardElement.className = `payment-card ${method.isDefault ? 'default' : ''}`;
                        cardElement.innerHTML = `
                            <div class="payment-card-header">
                                <span class="payment-card-type">Tarjeta de ${method.isDefault ? 'Crédito (Predeterminada)' : 'Crédito'}</span>
                                ${method.isDefault ? '<span class="payment-card-default">PREDETERMINADA</span>' : ''}
                            </div>
                            <div class="payment-card-number">${method.cardNumber}</div>
                            <div class="payment-card-details">
                                <span>${method.cardHolder}</span>
                                <span>Expira: ${method.expirationMonth}/${method.expirationYear}</span>
                            </div>
                            <div class="payment-card-actions">
                                <button class="btn-edit edit-card" data-id="${method.id}">Editar</button>
                                <button class="btn-cancel delete-card" data-id="${method.id}">Eliminar</button>
                                ${!method.isDefault ? `<button class="btn-edit set-default" data-id="${method.id}">Establecer como predeterminada</button>` : ''}
                            </div>
                            <div class="payment-card-balance">Saldo: $${method.balance.toFixed(2)}</div>
                        `;
                        paymentMethodsContainer.appendChild(cardElement);
                    });
                    
                    // Agregar event listeners a los botones
                    document.querySelectorAll('.edit-card').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const cardId = this.getAttribute('data-id');
                            await loadCardForEdit(cardId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-card').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const cardId = this.getAttribute('data-id');
                            if (confirm('¿Estás seguro de que deseas eliminar este método de pago?')) {
                                await deletePaymentMethod(cardId);
                            }
                        });
                    });
                    
                    document.querySelectorAll('.set-default').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const cardId = this.getAttribute('data-id');
                            await setDefaultPaymentMethod(cardId);
                        });
                    });
                    
                } catch (error) {
                    console.error('Error cargando métodos de pago:', error);
                    showAlert('Error al cargar métodos de pago', false);
                }
            }
            
            // Cargar tarjeta para editar
            async function loadCardForEdit(cardId) {
                try {
                    const user = getLoggedInUser();
                    const response = await fetch(`/api/payment-methods/${user.id}`);
                    if (!response.ok) {
                        throw new Error('Error al cargar tarjeta');
                    }
                    
                    const paymentMethods = await response.json();
                    const card = paymentMethods.find(m => m.id == cardId);
                    
                    if (!card) {
                        throw new Error('Tarjeta no encontrada');
                    }
                    
                    document.getElementById('paymentModalTitle').textContent = 'Editar Tarjeta';
                    document.getElementById('cardId').value = card.id;
                    document.getElementById('cardNumber').value = card.cardNumber;
                    document.getElementById('cardHolder').value = card.cardHolder;
                    document.getElementById('expirationMonth').value = card.expirationMonth;
                    document.getElementById('expirationYear').value = card.expirationYear;
                    document.getElementById('isDefault').checked = card.isDefault;
                    
                    paymentMethodModal.style.display = 'block';
                } catch (error) {
                    console.error('Error cargando tarjeta:', error);
                    showAlert('Error al cargar tarjeta para edición', false);
                }
            }
            
            // Guardar tarjeta
            paymentMethodForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const user = getLoggedInUser();
                if (!user) return;
                
                const cardId = document.getElementById('cardId').value;
                const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
                const cardHolder = document.getElementById('cardHolder').value;
                const expirationMonth = document.getElementById('expirationMonth').value;
                const expirationYear = document.getElementById('expirationYear').value;
                const cvv = document.getElementById('cvv').value;
                const initialBalance = document.getElementById('initialBalance').value || 0;
                const isDefault = document.getElementById('isDefault').checked;
                
                // Validaciones básicas
                if (!cardNumber || !cardHolder || !expirationMonth || !expirationYear || !cvv) {
                    showAlert('Todos los campos son requeridos', false);
                    return;
                }
                
                if (cardNumber.length < 13 || cardNumber.length > 16) {
                    showAlert('Número de tarjeta inválido', false);
                    return;
                }
                
                if (cvv.length < 3 || cvv.length > 4) {
                    showAlert('CVV inválido', false);
                    return;
                }
                
                try {
                    let response;
                    
                    if (cardId) {
                        // Editar tarjeta existente
                        response = await fetch(`/api/payment-methods/${cardId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                cardHolder,
                                expirationMonth,
                                expirationYear,
                                isDefault
                            })
                        });
                    } else {
                        // Agregar nueva tarjeta
                        response = await fetch('/api/payment-methods', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                userId: user.id,
                                cardNumber,
                                cardHolder,
                                expirationMonth,
                                expirationYear,
                                cvv,
                                balance: initialBalance
                            })
                        });
                    }
                    
                    if (!response.ok) {
                        throw new Error('Error al guardar tarjeta');
                    }
                    
                    const data = await response.json();
                    
                    showAlert(data.message || 'Tarjeta guardada correctamente');
                    paymentMethodModal.style.display = 'none';
                    loadPaymentMethods();
                } catch (error) {
                    console.error('Error guardando tarjeta:', error);
                    showAlert('Error al guardar tarjeta', false);
                }
            });
            
            // Eliminar tarjeta
            async function deletePaymentMethod(cardId) {
                try {
                    const response = await fetch(`/api/payment-methods/${cardId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Error al eliminar tarjeta');
                    }
                    
                    const data = await response.json();
                    showAlert(data.message || 'Tarjeta eliminada correctamente');
                    loadPaymentMethods();
                } catch (error) {
                    console.error('Error eliminando tarjeta:', error);
                    showAlert('Error al eliminar tarjeta', false);
                }
            }
            
            // Establecer tarjeta predeterminada
            async function setDefaultPaymentMethod(cardId) {
                try {
                    const response = await fetch(`/api/payment-methods/${cardId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            isDefault: true
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Error al establecer tarjeta predeterminada');
                    }
                    
                    const data = await response.json();
                    showAlert(data.message || 'Tarjeta establecida como predeterminada');
                    loadPaymentMethods();
                } catch (error) {
                    console.error('Error estableciendo tarjeta predeterminada:', error);
                    showAlert('Error al establecer tarjeta predeterminada', false);
                }
            }
            
            // Cargar métodos de pago al iniciar
            loadPaymentMethods();
            
            // Cargar perfil al iniciar
            loadProfile();
        });
    </script>
</body>
</html>