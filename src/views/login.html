<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - LIANZE</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/login.css">
    <style>
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="index.html" class="logo">LIANZE</a>
                <h1>Iniciar Sesión</h1>
                <p>Bienvenido de vuelta</p>
            </div>

            <form class="auth-form" id="loginForm">
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" class="input" required>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" class="input" required>
                </div>

                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" name="remember">
                        <span class="checkmark"></span>
                        Recordarme
                    </label>
                    <a href="forgot-password.html" class="forgot-link">¿Olvidaste tu contraseña?</a>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <button type="submit" class="btn btn-primary btn-full" id="submitBtn">Iniciar Sesión</button>
            </form>

            <div class="auth-footer">
                <p>¿No tienes cuenta? <a href="register.html">Regístrate aquí</a></p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const errorMessage = document.getElementById('errorMessage');
    const submitBtn = document.getElementById('submitBtn');

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    function redirectUser(userType) {
        if (userType === 'patient') {
            window.location.href = 'dashboard-patient.html';
        } else if (userType === 'psychologist') {
            window.location.href = 'dashboard-psychologist.html';
        } else {
            showError('Tipo de usuario no reconocido');
        }
    }

    // Función para mostrar modal MFA
    // Función para mostrar modal MFA
function showMFAModal(tempToken) {
    const modal = document.createElement('div');
    modal.className = 'mfa-modal';
    modal.style.display = 'block';
    
    modal.innerHTML = `
        <div class="mfa-modal-content">
            <h2>Autenticación de Dos Factores</h2>
            <p>Por favor ingresa uno de tus códigos de respaldo MFA</p>
            <input type="text" id="mfa-code" placeholder="Código MFA" style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
            <button id="verify-mfa-btn" class="btn-primary">Verificar</button>
            <button id="cancel-mfa-btn" class="btn-danger">Cancelar</button>
            <div id="mfa-error" style="color: #e74c3c; margin-top: 1rem; display: none;"></div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('verify-mfa-btn').addEventListener('click', async function() {
    const code = document.getElementById('mfa-code').value;
    const mfaError = document.getElementById('mfa-error');
    
    if (!code) {
        mfaError.textContent = 'Por favor ingresa un código MFA';
        mfaError.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch('/api/verify-mfa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tempToken: tempToken,
                code: code
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Error al verificar MFA');
        }
        
        const data = await response.json();
        
        // Guardar información del usuario en localStorage
        localStorage.setItem('user', JSON.stringify(data.user));
        // Redirigir según el tipo de usuario
        redirectUser(data.user.userType);
        document.body.removeChild(modal);
    } catch (error) {
        console.error('Error:', error);
        mfaError.textContent = error.message || 'Error al verificar MFA';
        mfaError.style.display = 'block';
    }
});
    
    // Manejar cancelación
    document.getElementById('cancel-mfa-btn').addEventListener('click', function() {
    document.body.removeChild(modal);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Iniciar Sesión';
});
    
    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            document.body.removeChild(modal);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Iniciar Sesión';
        }
    });
}




    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorMessage.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Iniciando sesión...';
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email,
                    password
                })
            });
            
            const data = await response.json();
            
           if (response.ok) {
            if (data.requiresMFA) {
                // Mostrar modal para ingresar código MFA
                showMFAModal(data.tempToken);
                // No restablecer el botón aquí, el modal manejará eso
            } else {
                // Guardar información del usuario en localStorage
                localStorage.setItem('user', JSON.stringify(data.user));
                // Redirigir según el tipo de usuario
                redirectUser(data.user.userType);
            }
        } else {
            showError(data.message || 'Credenciales incorrectas');
        }
        } catch (error) {
        console.error('Error:', error);
        showError('Ocurrió un error al iniciar sesión. Por favor, inténtalo más tarde.');
    } finally {
        // Solo restablecer el botón si no se mostró el modal MFA
        if (!document.querySelector('.mfa-modal')) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Iniciar Sesión';
        }
    }
    });
});
    </script>
</body>
</html>