<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña - LIANZE</title>
    <link rel="stylesheet" href="/css/forgot-password.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-header">
            <a href="index.html" class="logo">LIANZE</a>
            <h1>Recuperar Contraseña</h1>
            <p>Por favor verifica tu identidad</p>
        </div>

        <form id="forgotPasswordForm">
            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div id="securityQuestionContainer">
                <div class="security-question" id="securityQuestion"></div>
                <div class="form-group">
                    <label for="securityAnswer">Tu respuesta</label>
                    <input type="text" id="securityAnswer" name="securityAnswer" required>
                </div>
            </div>

            <div id="mfaContainer">
                <div class="form-group">
                    <label for="mfaCode">Código MFA</label>
                    <input type="text" id="mfaCode" name="mfaCode" placeholder="Ingresa uno de tus códigos de respaldo">
                </div>
            </div>

            <div id="newPasswordContainer">
                <div class="form-group">
                    <label for="newPassword">Nueva Contraseña</label>
                    <input type="password" id="newPassword" name="newPassword" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirmar Contraseña</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                </div>
            </div>

            <div class="form-group">
                <button type="button" id="nextBtn" class="btn btn-primary">Siguiente</button>
                <button type="button" id="resetBtn" class="btn btn-primary">Restablecer Contraseña</button>
            </div>

            <div id="errorMessage" class="error-message"></div>
        </form>

        <div class="support-section">
            <button id="toggleSupportBtn" class="btn btn-link">Contactar soporte</button>
            <form id="supportForm">
                <div class="form-group">
                    <label for="supportMessage">Describe tu problema</label>
                    <textarea id="supportMessage" rows="4" required></textarea>
                </div>
                <button type="button" id="submitSupportBtn" class="btn btn-secondary">Enviar Reporte</button>
            </form>
        </div>

        <div class="auth-footer">
            <p>¿Recordaste tu contraseña? <a href="login.html">Inicia sesión</a></p>
        </div>
    </div>

    <!-- Modal MFA -->
    <div id="mfaModal" class="mfa-modal">
        <div class="mfa-modal-content">
            <h2>Verificación MFA</h2>
            <p>Por favor ingresa uno de tus códigos de respaldo</p>
            <div class="form-group">
                <input type="text" id="modalMfaCode" placeholder="Código MFA">
            </div>
            <button id="verifyMfaBtn" class="btn btn-primary">Verificar</button>
            <button id="cancelMfaBtn" class="btn btn-danger">Cancelar</button>
            <div id="mfaError" class="error-message"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentStep = 0;
            let userData = {};
            let selectedQuestion = '';
            const questions = [
                "¿Cuál es el nombre de tu primera mascota?",
                "¿Cuál es tu color favorito?",
                "¿Cuál es tu lugar favorito?"
            ];

            // Elementos del DOM
            const emailInput = document.getElementById('email');
            const nextBtn = document.getElementById('nextBtn');
            const resetBtn = document.getElementById('resetBtn');
            const errorMessage = document.getElementById('errorMessage');
            const securityContainer = document.getElementById('securityQuestionContainer');
            const mfaContainer = document.getElementById('mfaContainer');
            const newPasswordContainer = document.getElementById('newPasswordContainer');
            const mfaModal = document.getElementById('mfaModal');
            const toggleSupportBtn = document.getElementById('toggleSupportBtn');
            const supportForm = document.getElementById('supportForm');

            // Inicializar visibilidad
            securityContainer.style.display = 'none';
            mfaContainer.style.display = 'none';
            newPasswordContainer.style.display = 'none';
            resetBtn.style.display = 'none';
            errorMessage.style.display = 'none';
            mfaModal.style.display = 'none';

            // Mostrar/ocultar formulario de soporte
            toggleSupportBtn.addEventListener('click', function() {
                supportForm.style.display = supportForm.style.display === 'none' ? 'block' : 'none';
            });

            // Manejar el flujo de recuperación
            nextBtn.addEventListener('click', async function() {
                try {
                    if (currentStep === 0) {
                        // Paso 1: Verificar email
                        const email = emailInput.value.trim();
                        if (!email) {
                            showError('Por favor ingresa tu correo electrónico');
                            return;
                        }
                        console.log('Enviando a:', 'http://localhost:3000/api/forgot-password/init');
console.log('Payload:', { email: emailInput.value.trim() });

                        const response = await fetch('http://localhost:3000/api/forgot-password/init', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email: emailInput.value.trim() })
                        });
                        console.log('Status:', response.status, response.statusText);
                        if (!response.ok) {
    const errorData = await response.json();
    throw new Error(errorData.message || 'Error en la solicitud');
}

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Error al verificar email');
                        }

                        userData = data;
                        
                        // Seleccionar pregunta aleatoria
                        const questionKeys = ['petName', 'favoriteColor', 'favoritePlace'];
                        selectedQuestion = questionKeys[Math.floor(Math.random() * questionKeys.length)];
                        
                        document.getElementById('securityQuestion').textContent = 
                            selectedQuestion === 'petName' ? questions[0] :
                            selectedQuestion === 'favoriteColor' ? questions[1] :
                            questions[2];
                        
                        // Mostrar siguiente paso
                        securityContainer.style.display = 'block';
                        emailInput.disabled = true;
                        currentStep = 1;
                        
                    } else if (currentStep === 1) {
                        // Paso 2: Verificar pregunta de seguridad
                        const answer = document.getElementById('securityAnswer').value.trim();
                        if (!answer) {
                            showError('Por favor ingresa tu respuesta');
                            return;
                        }

                        const response = await fetch('/api/forgot-password/verify-answer', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email: userData.email,
                                question: selectedQuestion,
                                answer
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Respuesta incorrecta');
                        }

                        if (data.requiresMFA) {
                            // Mostrar campo MFA
                            securityContainer.style.display = 'none';
                            mfaContainer.style.display = 'block';
                            currentStep = 2;
                        } else {
                            // Mostrar campo nueva contraseña
                            goToPasswordReset();
                        }
                    } else if (currentStep === 2) {
                        // Paso 3: Verificar MFA
                        const mfaCode = document.getElementById('mfaCode').value.trim();
                        if (!mfaCode) {
                            showError('Por favor ingresa tu código MFA');
                            return;
                        }

                        const response = await fetch('/api/forgot-password/verify-mfa', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email: userData.email,
                                code: mfaCode
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Código MFA inválido');
                        }

                        // Mostrar campo nueva contraseña
                        goToPasswordReset();
                    }
                } catch (error) {
                    showError(error.message);
                }
            });

            // Función para ir al paso de restablecer contraseña
            function goToPasswordReset() {
                mfaContainer.style.display = 'none';
                newPasswordContainer.style.display = 'block';
                nextBtn.style.display = 'none';
                resetBtn.style.display = 'block';
                currentStep = 3;
            }

            // Restablecer contraseña
            resetBtn.addEventListener('click', async function() {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!newPassword || !confirmPassword) {
                    showError('Por favor completa ambos campos');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showError('Las contraseñas no coinciden');
                    return;
                }

                try {
                    const response = await fetch('/api/forgot-password/reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: userData.email,
                            newPassword
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Error al restablecer contraseña');
                    }

                    alert('Contraseña restablecida con éxito. Ahora puedes iniciar sesión.');
                    window.location.href = 'login.html';
                } catch (error) {
                    showError(error.message);
                }
            });

            // Mostrar errores
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }

            // Manejo del modal MFA
            const verifyMfaBtn = document.getElementById('verifyMfaBtn');
            const cancelMfaBtn = document.getElementById('cancelMfaBtn');
            const modalMfaCode = document.getElementById('modalMfaCode');
            const mfaError = document.getElementById('mfaError');

            verifyMfaBtn.addEventListener('click', async function() {
                const code = modalMfaCode.value.trim();
                if (!code) {
                    mfaError.textContent = 'Por favor ingresa el código';
                    mfaError.style.display = 'block';
                    return;
                }

                try {
                    const response = await fetch('/api/forgot-password/verify-mfa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: userData.email,
                            code: code
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Código MFA inválido');
                    }

                    mfaModal.style.display = 'none';
                    goToPasswordReset();
                } catch (error) {
                    mfaError.textContent = error.message;
                    mfaError.style.display = 'block';
                }
            });

            cancelMfaBtn.addEventListener('click', function() {
                mfaModal.style.display = 'none';
            });
        });
    </script>
</body>
</html> 